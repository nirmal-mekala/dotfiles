#!/usr/bin/env bash

EXTRA_NDM="+ndm_custom(hjkl_arrows)+ndm_custom(bracket_escape)+ndm_custom(swap_r_command)"
CAPSLOCK="+capslock(groupshift)"
OUTPUT_FILE="ndm.xkb"

if [ -t 0 ] && [ -n "$1" ]; then
    INPUT="$1"
    exec < "$INPUT"
elif [ -t 0 ]; then
    echo "Usage: $0 [optional-xkb-file] < input.xkb"
    exit 1
fi

awk -v ndm="$EXTRA_NDM" -v cap="$CAPSLOCK" '
function clean_symbols(sym_line) {
    match(sym_line, /include[ \t]*"([^"]+)"/, m)
    if (!m[1]) {
        print sym_line
        return
    }

    symbols = m[1]

    # Remove existing capslock(groupshift) and all ndm_custom(...)
    gsub(/\+capslock\(groupshift\)/, "", symbols)
    gsub(/\+ndm_custom\([^)]+\)/, "", symbols)

    # Insert before first +inet(...) if found
    if (symbols ~ /\
