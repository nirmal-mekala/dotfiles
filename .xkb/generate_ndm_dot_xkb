#!/bin/bash

EXTRA_NDM="+ndm_custom(hjkl_arrows)+ndm_custom(bracket_escape)+ndm_custom(swap_r_command)"
CAPSLOCK="+capslock(groupshift)"
OUTPUT_FILE="ndm.xkb"

# Handle file or stdin
if [ -t 0 ] && [ -n "$1" ]; then
    INPUT="$1"
    exec < "$INPUT"
elif [ -t 0 ]; then
    echo "Usage: $0 [optional-xkb-file] < input.xkb"
    exit 1
fi

awk -v ndm="$EXTRA_NDM" -v cap="$CAPSLOCK" '
{
    if ($1 == "xkb_symbols") {
        # Remove all ndm_custom(...) and capslock(groupshift)
        gsub(/\+ndm_custom\([^)]+\)/, "")
        gsub(/\+capslock\(groupshift\)/, "")

        # Ensure +capslock(groupshift) is included right after base layout
        match($0, /xkb_symbols[ \t]*\{[ \t]*include[ \t]*"/)
        prefix = substr($0, 1, RLENGTH)
        remainder = substr($0, RLENGTH + 1)

        # Insert capslock and ndm options before inet(evdev)
        gsub(/\+inet\(evdev\)/, cap ndm "+inet(evdev)", remainder)

        # Reconstruct line
        print prefix remainder
    } else {
        print
    }
}
' > "$OUTPUT_FILE"

echo "Updated keymap written to $OUTPUT_FILE"
