#!/usr/bin/env bash

SEARCH="$1"
BRANCH="${2:-origin/main}"

if [ -z "$SEARCH" ]; then
  echo "Usage: $0 <search-string> [branch]"
  exit 1
fi

# Newline-separated list of files with added lines matching $SEARCH
FILES=$(
  git diff "$BRANCH"... -U0 \
  | awk -v s="$SEARCH" '
      # Track current file from +++ b/path
      /^\+\+\+ b\// {
        file = substr($2, 3); # strip "b/"
        next
      }

      # Only look at *added* lines (start with "+", but not "+++")
      /^\+/ && !/^\+\+\+/ {
        # $0 includes leading "+", so search after it or including it
        line = substr($0, 2)
        if (index(line, s) > 0 && file != "") {
          print file
        }
      }
    ' \
  | sort -u
)

# If you want to inspect the variable:
# printf 'Matched files:\n%s\n' "$FILES"

# Open each file in its own Neovim tab
if [ -n "$FILES" ]; then
  printf '%s\n' "$FILES" | xargs -r nvim -p
else
  echo "No added lines containing '$SEARCH' vs $BRANCH"
fi
